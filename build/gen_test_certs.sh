#!/bin/bash -e

echo -e "WARNING: TEST KEYS AND CERTIFICATES GENERATED BY THIS SCRIPT ARE FOR \
EVALUATING THE SETUP ONLY - NOT INTENDED FOR FOR A PRODUCTION USE\n"

set -x

# using test with 'sudo' because of case, where crt files are not visible for non-root users
if ! sudo test -f build/certs/public/ca.crt; then
	# Generate root CA cert
	openssl req -nodes -x509 -newkey rsa:3072 -keyout build/certs/public/ca.key -out build/certs/public/ca.crt -subj "/O=AppQoS/OU=root/CN=localhost" 

    # giving access rights for the ca cert key only to the root user
    sudo chown root build/certs/public/ca.key
fi

if ! sudo test -f build/certs/public/appqos.crt; then
    openssl req -nodes -newkey rsa:3072 -keyout build/certs/public/appqos.key -out build/certs/public/appqos.csr -subj "/O=AppQoS/OU=AppQoS Server/CN=localhost"
    sudo openssl x509 -req -in build/certs/public/appqos.csr -CA build/certs/public/ca.crt -CAkey build/certs/public/ca.key -CAcreateserial -out build/certs/public/appqos.crt

    # changing the ownership of the appqos cert and key - to match credentials of the user that will launch
    # the AppQoS server
    sudo chown root build/certs/public/appqos.crt build/certs/public/appqos.csr build/certs/public/ca.key
fi

if ! sudo test -f build/certs/private/client_appqos.crt; then
    # Generate client_appqos cert and sign it
    openssl req -nodes -newkey rsa:3072 -keyout build/certs/private/client_appqos.key -out build/certs/private/client_appqos.csr -subj "/O=AppQoS/OU=AppQoS Client/CN=client_host"
    sudo openssl x509 -req -in build/certs/private/client_appqos.csr -CA build/certs/public/ca.crt -CAkey build/certs/public/ca.key -out build/certs/private/client_appqos.crt
fi
